# P1｜抖音本地生活（餐饮）仿真数据：从“GMV增长”到“履约与结算质量”的经营诊断

## 1. 我在解决什么问题
在本地生活业务里，GMV不等于健康增长：我要用可复现的数据与SQL分析，回答“增长是否可履约、退款风险在哪、渠道效率如何、店铺该怎么分层治理”。

---

## 2. 数据与口径
**数据来源：**自研生成器生成仿真业务数据，落库 MySQL（`portfolio_db`），全流程可复现。  
**核心事实：**业务的“钱”与“质量”分散在不同链路：
- 交易：支付GMV、核销GMV、退款金额（`05_douyin_shop_metric` / `03_douyin_order`）
- 流量：曝光→点击→详情（`04_douyin_traffic_daily`）
- 商品：SKU定价、活动、补贴（`02_douyin_sku`）
- 门店属性：品类/客单/是否连锁/是否签约（`01_douyin_shop`）

---

## 3. 我输出了什么
### 3.1 可复现工程
- DDL：`p1_sql_warehouse/ddl/create_table_01-05.sql`
- 数据生成：`p1_sql_warehouse/etl/generator.py`

### 3.2 SQL Analysis Layer（SQL01–SQL12）
- SQL01：店铺日GMV与履约质量（支付、核销、核销率）
- SQL02：渠道核销率对比（search/short_video/live）
- SQL03：渠道AOV对比（客单结构）
- SQL04：退款率与退款结构（按渠道/是否核销）
- SQL05：渠道→店铺GMV贡献（结构与集中度）
- SQL06：店铺履约能力分层（GMV × 核销率 四象限）
- SQL07：核销延迟/退款的根因拆解（诊断链路）
- SQL08：流量到支付漏斗（曝光→点击→详情→支付）
- SQL09：SKU定价与活动效果（活动SKU/补贴/折扣）
- SQL10：签约 vs 非签约的结算表现（平台佣金/返利/到手）
- SQL11：连锁 vs 单店经营表现对比
- SQL12：结算质量（抽佣/手续费/返利/到手与占比）

### 3.3 结果快照
- SQL06：`docs/results/SQL06_shop_fulfillment_quadrant.(csv/png)`
- SQL12：`docs/results/SQL12_settlement_quality.(csv/png)`

---

## 4. 关键发现
### 4.1 “高GMV≠高质量”：四象限分层用于门店治理（SQL06）
我把门店按 **GMV规模（pay_gmv_30d）× 核销率（writeoff_rate_30d）** 分成四类：
- **Q1 高GMV×高核销（核心优质）**：优先加预算/扩品/放大曝光
- **Q2 高GMV×低核销（履约短板）**：重点排查“核销延迟、退款原因、门店承接能力”
- **Q3 低GMV×高核销（增长潜力）**：适合做流量扶持/活动放量
- **Q4 低GMV×低核销（治理/淘汰）**：控制成本，清理低质量供给

**可控动作：**
- 对 Q2：先查核销延迟与退款结构（SQL07），再优化履约与售后策略
- 对 Q3：用渠道漏斗与活动SKU验证增长手段（SQL08/SQL09）
- 对 Q4：限制补贴、减少资源投入，避免“带病增长”

### 4.2 “到手=支付GMV -（抽佣+手续费）+返利”：结算质量是利润真相（SQL12）
我把门店30天结算拆成：
- 平台抽佣（commission）
- 支付手续费（payment_fee）
- 返利（rebate_amount）
- 最终到手（settlement_amount）
并计算占比，回答“哪个门店看起来GMV高，但到手可能并不理想”。

**可控动作：**
- 对抽佣高的门店：结合签约状态、返利策略（SQL10）谈判/调整
- 对到手低的门店：回到履约与退款，减少无效成交（SQL06/SQL04）

---

## 5. 我如何验证“分析是正确的”
- 口径一致：支付GMV、核销GMV、退款金额来自指标表（`05_douyin_shop_metric`）
- 防止除零：比率计算使用 `NULLIF`
- 结算一致性：`settlement_amount` 与“抽佣/手续费/返利”拆解关系在 SQL12 中显式呈现
- 时间窗口一致：统一最近30天，避免跨口径比较
